<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAK RUPIAH - Simulasi Interaktif Mata Uang Rupiah</title>

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Titan+One&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            /* MODIFIED: Changed from solid color to a fresh 3-color gradient */
            background-color: #22d3ee;
            background-image:
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"),
                linear-gradient(135deg, #34d399 0%, #22d3ee 50%, #3b82f6 100%);
            /* Emerald to Cyan to Blue */
            background-attachment: fixed;
            background-size: auto, cover;
            overflow: hidden;
            touch-action: manipulation;
        }

        .bg-pattern {
            /* Kept specific pattern for overlays if needed, though body handles main bg now */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* NEW: Money Background Pattern for Slot Area */
        .bg-money-pattern {
            background-color: rgba(255, 255, 255, 0.9);
            background-image: url("data:image/svg+xml,%3Csvg width='80' height='40' viewBox='0 0 80 40' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='50%25' y='50%25' font-family='sans-serif' font-weight='bold' font-size='14' fill='%2316a34a' fill-opacity='0.15' text-anchor='middle' dominant-baseline='middle' transform='rotate(-15 40 20)'%3ERp%3C/text%3E%3C/svg%3E");
        }

        /* Custom Scrollbar */
        .money-tray::-webkit-scrollbar {
            height: 8px;
        }

        .money-tray::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .money-tray::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* Money Styling */
        .money-card {
            transition: transform 0.1s, box-shadow 0.1s;
            cursor: grab;
            user-select: none;
        }

        .money-card:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .money-coin {
            border-radius: 50%;
            box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .money-paper {
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            position: relative;
            overflow: hidden;
        }

        .money-paper::before {
            content: '';
            position: absolute;
            left: -10%;
            top: 0;
            width: 20%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
        }

        .money-paper::after {
            content: '';
            position: absolute;
            right: -10%;
            top: 0;
            width: 20%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-20deg);
        }

        /* Animations */
        @keyframes popIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce-custom {
            animation: bounce 2s infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-15px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        /* NEW: Floating Money Down Animation (Rain) */
        @keyframes floatDown {
            0% {
                transform: translateY(-20vh) rotate(0deg) translateX(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(120vh) rotate(360deg) translateX(20px);
                opacity: 0;
            }
        }

        .floating-money {
            position: absolute;
            top: -150px;
            /* Start above screen */
            pointer-events: none;
            z-index: 1;
            /* Above background pattern, below content */
        }

        .drop-zone-active {
            background-color: rgba(254, 240, 138, 0.5);
            /* Yellow tint */
            border-color: #fde047;
            transform: scale(1.02);
        }

        .hidden {
            display: none !important;
        }

        /* Disabled Money Style */
        .money-disabled {
            filter: grayscale(100%);
            opacity: 0.4;
            cursor: not-allowed !important;
        }

        /* NEW: Typography Logo Style */
        .typography-logo {
            font-family: 'Titan One', cursive;
            /* UPDATED to Fun Font */
            font-weight: 400;
            /* Titan One is explicitly 400 */
            color: #fbbf24;
            /* Amber-400 Main Fill */
            -webkit-text-stroke: 3px #92400e;
            /* Amber-800 Outline - Bold & Comic-like */
            text-shadow:
                4px 4px 0 #92400e,
                /* Hard Shadow */
                8px 8px 0 #00000020;
            /* Soft Drop Shadow */
            letter-spacing: 4px;
            line-height: 1.1;
        }
    </style>
</head>

<body class="min-h-screen w-full flex flex-col relative overflow-x-hidden">

    <!-- START SCREEN -->
    <!-- GLOBAL BACKGROUND (Moved from start-screen) -->
    <div id="global-bg" class="absolute inset-0 z-[-1] bg-gradient-to-br from-emerald-400 via-cyan-500 to-blue-600">
        <div class="absolute inset-0 opacity-20 bg-pattern pointer-events-none"></div>
    </div>

    <!-- GLOBAL ANIMATION CONTAINER -->
    <div id="floating-money-container" class="absolute inset-0 pointer-events-none overflow-hidden z-0"></div>

    <!-- MODIFIED: Start screen is now transparent wrapper for content -->
    <div id="start-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 overflow-y-auto">




        <!-- MOVED OUTSIDE: Title and Subtitle now separate from the instruction box -->
        <div class="text-center z-10 mb-2 md:mb-4 animate-float mt-4 md:mt-0">
            <h1 class="text-4xl md:text-7xl mb-1 typography-logo leading-tight drop-shadow-2xl">SIMAK<br>RUPIAH</h1>
            <p
                class="text-white text-[10px] md:text-base font-bold uppercase tracking-wider bg-black/20 backdrop-blur-sm py-1.5 px-3 md:px-5 rounded-full inline-block mx-auto border border-white/30 shadow-lg">
                (Simulasi Interaktif Mata Uang Rupiah)</p>
        </div>

        <div
            class="bg-white/95 backdrop-blur-md p-4 md:p-8 rounded-3xl shadow-2xl max-w-4xl w-full relative z-10 border-4 border-white/50 mb-4">

            <div class="grid md:grid-cols-2 gap-4 md:gap-8 items-start text-left">
                <!-- LEFT COLUMN: Instructions & Tips -->
                <div
                    class="bg-blue-50 rounded-xl p-3 md:p-5 border-2 border-blue-100 text-xs md:text-sm h-full flex flex-col justify-center">
                    <h3
                        class="font-bold text-blue-800 mb-3 flex items-center gap-2 text-sm md:text-base border-b border-blue-200 pb-2">
                        <i class="fas fa-info-circle"></i> Cara Bermain:
                    </h3>
                    <ul class="text-gray-700 space-y-2 mb-4">
                        <li class="flex items-start gap-3">
                            <span
                                class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">1</span>
                            <span>Lihat jumlah uang & syaratnya.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span
                                class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">2</span>
                            <span><b>Tarik/Klik</b> uang ke kotak atas.</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span
                                class="bg-blue-200 text-blue-800 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shrink-0 mt-0.5">3</span>
                            <span>Klik tombol <b>TUKAR SEKARANG</b>.</span>
                        </li>
                    </ul>

                    <div class="mt-auto pt-3 border-t-2 border-dashed border-blue-200">
                        <h4 class="font-bold text-blue-800 mb-2 flex items-center gap-1"><i
                                class="fas fa-lightbulb text-yellow-500"></i> Tips:</h4>
                        <ul class="list-disc list-inside space-y-1 pl-1 italic text-blue-900">
                            <li>Waktu main <b>60 detik</b>/level.</li>
                            <li>Klik <b>Home (üè†)</b> untuk simpan skor & keluar.</li>
                            <li>Namamu otomatis masuk <b>Leaderboard</b>!</li>
                        </ul>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Actions -->
                <div class="space-y-3 md:space-y-4 flex flex-col justify-center h-full">
                    <!-- NEW: Name Input Field -->
                    <div class="relative group">
                        <div
                            class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none transition-colors group-focus-within:text-teal-500">
                            <i class="fas fa-user text-gray-400"></i>
                        </div>
                        <input type="text" id="player-name-input"
                            class="w-full pl-10 pr-4 py-3 md:py-4 rounded-full border-2 border-gray-200 focus:border-teal-400 focus:ring-4 focus:ring-teal-100 transition text-center text-base md:text-xl font-bold text-teal-800 placeholder-gray-400 shadow-inner"
                            placeholder="Ketikan namamu..." autocomplete="off">
                    </div>

                    <button onclick="checkNameAndStart()"
                        class="w-full bg-gradient-to-r from-green-400 to-green-600 hover:from-green-500 hover:to-green-700 text-white text-lg md:text-2xl font-bold py-3 md:py-4 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2 ring-4 ring-green-100 group">
                        <i class="fas fa-play group-hover:animate-pulse"></i> MULAI MAIN
                    </button>

                    <button onclick="showLeaderboardUI()"
                        class="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-700 border-2 border-yellow-400 text-sm md:text-lg font-bold py-2 md:py-3 rounded-full shadow-md transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-trophy"></i> PAPAN PERINGKAT
                    </button>

                    <button onclick="showAbout()"
                        class="w-full bg-white hover:bg-gray-100 text-teal-600 border-2 border-teal-200 text-sm md:text-lg font-bold py-2 md:py-3 rounded-full shadow-md transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
                        <i class="fas fa-users"></i> TENTANG APLIKASI
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-auto md:mt-8 text-white/80 text-xs md:text-sm font-medium tracking-wider text-center pb-4">
            KHARISMA MUDA &copy; 2025
        </div>
    </div>

    <!-- GAME VIEW WRAPPER -->
    <div id="game-view" class="hidden flex-col min-h-screen w-full">

        <!-- Header / Stats -->
        <div class="w-full flex justify-between items-center px-3 md:px-6 pt-2 z-10 shrink-0 gap-2">
            <div class="flex items-center gap-2">
                <button onclick="backToHome()"
                    class="bg-white/20 hover:bg-white/40 text-white p-1.5 md:p-2 rounded-full transition shadow-lg">
                    <i class="fas fa-home text-sm md:text-base"></i>
                </button>

                <button onclick="toggleMusic()" id="music-btn"
                    class="bg-white/20 hover:bg-white/40 text-white p-1.5 md:p-2 rounded-full transition shadow-lg">
                    <i class="fas fa-volume-up text-sm md:text-base"></i>
                </button>

                <!-- NEW: Greeting Display -->
                <div id="greeting-display"
                    class="hidden md:flex items-center px-3 py-1 bg-white/20 rounded-full text-white text-xs md:text-sm font-bold border border-white/20 whitespace-nowrap">
                    Halo, <span id="player-name-display" class="ml-1 text-yellow-300">Player</span>!
                </div>

                <div id="lives-container" class="flex gap-0.5 md:gap-1">
                    <!-- Hearts injected via JS -->
                </div>
            </div>

            <!-- Timer Display -->
            <div id="timer-display"
                class="font-bold text-xl md:text-2xl text-white drop-shadow-md bg-black/20 px-3 py-1 rounded-lg border border-white/20">
                01:00
            </div>

            <div
                class="bg-indigo-600 text-white px-2 md:px-4 py-0.5 md:py-1 rounded-lg font-bold shadow-lg border-2 border-indigo-400 text-xs md:text-sm animate-pulse whitespace-nowrap">
                LEVEL <span id="level-display" class="text-yellow-300 text-sm md:text-lg ml-1">1</span>
            </div>

            <div
                class="bg-yellow-400 text-yellow-900 px-2 md:px-4 py-0.5 md:py-1 rounded-full font-bold text-sm md:text-lg shadow-lg border-2 border-yellow-200 flex items-center gap-1 md:gap-2">
                <i class="fas fa-star text-xs md:text-base"></i>
                <span id="score">0</span>
            </div>
        </div>

        <!-- Main Game Area -->
        <div
            class="flex-1 flex flex-col lg:flex-row w-full max-w-7xl mx-auto p-2 gap-2 relative pb-48 md:pb-64 lg:pb-80">

            <!-- Left Side: Drop Slots -->
            <div class="w-full lg:w-1/2 flex flex-col shrink-0">
                <!-- Added bg-money-pattern class here -->
                <div
                    class="bg-money-pattern rounded-2xl p-2 shadow-xl h-auto min-h-[200px] md:min-h-[250px] flex flex-col border-4 border-white/50">
                    <h3
                        class="text-center text-green-800 font-bold mb-1 uppercase tracking-wider text-[10px] md:text-sm bg-white/80 rounded-lg py-0.5 shadow-sm">
                        Area Penyimpanan Uang</h3>
                    <!-- Modified Grid: Responsive columns, REMOVED overflow-y-auto to prevent scrollbar -->
                    <div class="grid grid-cols-3 sm:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-1 md:gap-2 content-start md:content-center"
                        id="slots-container">
                        <!-- Slots injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Right Side: Interaction -->
            <div class="w-full lg:w-1/2 flex flex-col relative shrink-0">
                <!-- Added pt-10 (padding top) to prevent bubble clipping and ensure symmetry -->
                <div
                    class="flex-1 flex flex-col items-center justify-center relative min-h-[120px] md:min-h-[150px] pt-2 md:pt-6 pb-1 md:pb-2">

                    <!-- Speech Bubble -->
                    <div
                        class="relative bg-teal-700 text-white p-2 md:p-4 rounded-xl shadow-xl border-4 border-teal-500 mb-1 max-w-md w-full text-center z-10 mx-4">
                        <p class="text-[10px] md:text-base font-medium opacity-90">Saya ingin menukar uang:</p>
                        <h2 class="text-lg md:text-2xl font-bold text-yellow-300 my-0.5" id="target-amount">Rp 0</h2>

                        <div id="constraint-area"
                            class="mt-0.5 bg-teal-800/60 p-1 rounded-lg border border-teal-500/50 hidden">
                            <p class="text-[10px] md:text-sm text-teal-200 mb-0.5 uppercase tracking-wide font-bold">
                                Hanya
                                gunakan pecahan:</p>
                            <div id="constraint-icons" class="flex justify-center flex-wrap gap-1"></div>
                        </div>
                        <p id="default-instruction" class="text-[8px] md:text-[10px] opacity-80 mt-0.5">Geser uang ke
                            slot
                            yang sesuai!</p>
                        <div
                            class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-t-[15px] border-t-teal-700 border-r-[10px] border-r-transparent">
                        </div>
                    </div>

                    <div class="w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 relative mt-1 mb-1 shrink-0">
                        <div class="w-20 h-20 md:w-32 md:h-32 lg:w-40 lg:h-40 relative mt-1 mb-1 shrink-0">
                            <img id="kiki-char" src="assets/img/char/char1.png" alt="Kiki Character"
                                class="w-full h-full object-contain drop-shadow-2xl transition-transform duration-300 hover:scale-110">
                        </div>
                    </div>
                </div>

                <div
                    class="h-auto bg-gray-200 rounded-t-2xl p-2 md:p-3 border-t-4 md:border-t-8 border-gray-300 shadow-2xl relative shrink-0">
                    <div
                        class="bg-gray-800 rounded-lg p-1.5 md:p-2 mb-1.5 md:mb-2 border-2 md:border-4 border-gray-600 shadow-inner">
                        <div class="text-gray-400 text-[8px] md:text-[10px] font-mono uppercase text-right">Total
                            Terkumpul
                        </div>
                        <div class="text-green-400 font-mono text-xl md:text-3xl text-right font-bold tracking-widest"
                            id="current-total">0</div>
                    </div>

                    <button onclick="checkAnswer()"
                        class="w-full bg-green-500 hover:bg-green-600 active:bg-green-700 text-white text-base md:text-xl font-bold py-2 md:py-3 rounded-lg md:rounded-xl shadow-[0_3px_0_rgb(21,128,61)] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-cash-register"></i> TUKAR SEKARANG
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Tray -->
        <div
            class="fixed bottom-0 left-0 h-20 md:h-28 lg:h-32 bg-gray-800/90 backdrop-blur-md w-full shadow-[0_-4px_10px_rgba(0,0,0,0.3)] z-50 flex flex-col shrink-0">
            <div class="text-white text-[10px] md:text-xs text-center py-1 opacity-70 uppercase tracking-widest">
                <i class="fas fa-hand-pointer mr-1"></i> Tarik uang dari sini atau klik untuk ambil
            </div>
            <!-- Added md:justify-center to center the money on larger screens -->
            <div class="flex-1 flex items-center gap-2 md:gap-4 overflow-x-auto px-4 md:px-6 pb-2 money-tray lg:justify-center"
                id="money-source">
                <!-- Money injected via JS -->
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal"
        class="fixed inset-0 bg-black/70 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl p-6 md:p-8 max-w-lg w-full text-center relative shadow-2xl animate-pop-in">
            <button onclick="closeAbout()"
                class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition text-2xl">
                <i class="fas fa-times-circle"></i>
            </button>

            <div class="mb-4">
                <div class="inline-block bg-teal-100 p-3 rounded-full mb-2">
                    <i class="fas fa-users text-3xl text-teal-600"></i>
                </div>
                <h2 class="text-2xl md:text-3xl font-bold text-teal-700">TENTANG KAMI</h2>
                <div class="h-1 w-20 bg-yellow-400 mx-auto mt-2 rounded-full"></div>
            </div>

            <div class="text-left bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                <h3 class="font-bold text-gray-800 mb-1">Developer:</h3>
                <h4 class="text-xl font-bold text-indigo-600 mb-2">KHARISMA MUDA</h4>
                <p class="text-xs text-gray-500 mb-3 italic border-l-4 border-yellow-400 pl-2">
                    "KHARISMA" adalah singkatan nama kami, dan "MUDA" merepresentasikan asal sekolah kami, <b>SDS Plus 2
                        Al-Muhajirin</b>.
                </p>

                <h3 class="font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide">Tim Pengembang:</h3>
                <ul class="space-y-2">
                    <li class="flex items-center gap-3 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                        <div
                            class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                            H</div>
                        <span class="font-medium text-gray-700">Haris Ratno Pambudi, S.T</span>
                    </li>
                    <li class="flex items-center gap-3 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                        <div
                            class="bg-pink-100 text-pink-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                            N</div>
                        <span class="font-medium text-gray-700">Nur Afifah Ramadhani, S.Pd</span>
                    </li>
                    <li class="flex items-center gap-3 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                        <div
                            class="bg-purple-100 text-purple-600 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                            R</div>
                        <span class="font-medium text-gray-700">Rahmayani Putri, S.Pd</span>
                    </li>
                </ul>
            </div>

            <p class="text-xs text-center text-gray-400">
                Aplikasi ini dibuat sebagai media pembelajaran interaktif untuk mengenal dan menghitung mata uang
                Rupiah.
            </p>
            </p>

            <p class="text-xs text-center text-gray-400 mt-4">
                Dibuat dengan ‚ù§Ô∏è untuk pendidikan Indonesia.
            </p>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="modal-overlay"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center transform scale-90 transition-transform duration-300"
            id="modal-content">
            <div id="modal-icon" class="text-6xl mb-4 animate-bounce"></div>
            <h2 id="modal-title" class="text-3xl font-bold mb-2">Title</h2>
            <p id="modal-message" class="text-gray-600 mb-6 text-lg">Message</p>
            <button onclick="closeModal()"
                class="bg-cyan-500 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg hover:bg-cyan-600 transition-colors w-full">
                LANJUT MAIN
            </button>
        </div>
    </div>

    <!-- Background Music: Autoplay enabled -->
    <audio id="bg-music" loop preload="auto" autoplay src="assets/music/music-bg.mp3"
        onerror="alert('Error loading music file: ' + this.error.code)"></audio>

    <!-- LEADERBOARD MODAL -->
    <div id="leaderboard-modal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div
            class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100 border-4 border-yellow-400">
            <!-- Header -->
            <div class="bg-yellow-400 p-4 text-center relative">
                <h2 class="text-2xl font-black text-yellow-900 uppercase tracking-wide drop-shadow-md">
                    <i class="fas fa-trophy text-white mr-2"></i> Papan Peringkat
                </h2>
                <button onclick="closeLeaderboard()"
                    class="absolute top-4 right-4 text-yellow-800 hover:text-white transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <table class="w-full text-sm md:text-base">
                    <thead class="bg-yellow-50 text-yellow-800 mb-2">
                        <tr>
                            <th class="py-2 px-2 rounded-l-lg">Rank</th>
                            <th class="py-2 px-2 text-left">Nama</th>
                            <th class="py-2 px-2">Level</th>
                            <th class="py-2 px-2 rounded-r-lg">Waktu (Rata¬≤)</th>
                        </tr>
                    </thead>
                    <tbody id="lb-body" class="divide-y divide-gray-100">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 p-4 text-center">
                <button onclick="closeLeaderboard()"
                    class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full font-bold shadow-lg transition transform hover:scale-105">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    </div>

    <!-- FIREBASE SDK & CONFIG -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0WuC0FtjfJjYM_gZ2QY13iYEbAqo1N04",
            authDomain: "fir-config-9170d.firebaseapp.com",
            projectId: "fir-config-9170d",
            storageBucket: "fir-config-9170d.firebasestorage.app",
            messagingSenderId: "500458019532",
            appId: "1:500458019532:web:685d46fd4ea81ee57d0069",
            measurementId: "G-VQEMNTKBBP"
        };



        // Initialize Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init failed (Did you set the config?):", e);
        }

        // Expose Firestore functions to global scope for the main script to use
        window.FirebaseAPI = {
            db,
            collection,
            addDoc,
            getDocs,
            query,
            orderBy,
            limit,
            setDoc,
            doc
        };
    </script>

    <!-- Main Logic Script -->
    <script>
        // --- SOUND CONTROLLER (Web Audio API) ---
        // Generates sounds using the browser's synthesizer. No external files needed.
        const SoundController = {
            ctx: null,
            init: function () {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } else if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            playTone: function (freq, type, duration, delay = 0) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + delay);

                // Attack and Decay
                gain.gain.setValueAtTime(0, this.ctx.currentTime + delay);
                gain.gain.linearRampToValueAtTime(0.1, this.ctx.currentTime + delay + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + delay + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + delay);
                osc.stop(this.ctx.currentTime + delay + duration);
            },
            playClick: function () {
                this.init();
                // Short 'tick'
                this.playTone(800, 'sine', 0.1);
            },
            playPaper: function () {
                this.init();
                // Softer 'pop'
                this.playTone(400, 'triangle', 0.1);
            },
            playCoin: function () {
                this.init();
                // High metallic 'ting'
                this.playTone(1500, 'sine', 0.1);
                this.playTone(2000, 'sine', 0.3, 0.05);
            },
            playWin: function () {
                this.init();
                // Major arpeggio
                this.playTone(523.25, 'triangle', 0.2, 0); // C5
                this.playTone(659.25, 'triangle', 0.2, 0.15); // E5
                this.playTone(783.99, 'triangle', 0.4, 0.30); // G5
                this.playTone(1046.50, 'square', 0.6, 0.45); // C6
            },
            playError: function () {
                this.init();
                // Low descending buzz
                this.playTone(150, 'sawtooth', 0.3, 0);
                this.playTone(100, 'sawtooth', 0.4, 0.15);
            }
        };

        // --- Data Configuration ---
        // NEW: Character Images for Randomization
        const characterImages = [
            'assets/img/char/char1.png',
            'assets/img/char/char2.png',
            'assets/img/char/char3.png',
            'assets/img/char/char4.png'
        ];

        function updateCharacterImage() {
            const charImg = document.getElementById('kiki-char');
            if (charImg) {
                const randomChar = characterImages[Math.floor(Math.random() * characterImages.length)];
                charImg.src = randomChar;
                // Add pop animation reset
                charImg.classList.remove('animate-pop-in');
                void charImg.offsetWidth; // Trigger reflow
                charImg.classList.add('animate-pop-in');
            }
        }

        const denominations = [
            {
                val: 100000,
                label: '100.000',
                type: 'paper',
                img: 'assets/img/100000.png',
                color: 'bg-gradient-to-br from-red-500 to-red-700',
                text: 'text-white border-red-200'
            },
            {
                val: 50000,
                label: '50.000',
                type: 'paper',
                img: 'assets/img/50000.png',
                color: 'bg-gradient-to-br from-blue-500 to-blue-700',
                text: 'text-white border-blue-200'
            },
            {
                val: 20000,
                label: '20.000',
                type: 'paper',
                img: 'assets/img/20000.png',
                color: 'bg-gradient-to-br from-green-500 to-green-700',
                text: 'text-white border-green-200'
            },
            {
                val: 10000,
                label: '10.000',
                type: 'paper',
                img: 'assets/img/10000.png',
                color: 'bg-gradient-to-br from-purple-500 to-purple-700',
                text: 'text-white border-purple-200'
            },
            {
                val: 5000,
                label: '5.000',
                type: 'paper',
                img: 'assets/img/5000.png',
                color: 'bg-gradient-to-br from-amber-500 to-amber-700',
                text: 'text-white border-amber-200'
            },
            {
                val: 2000,
                label: '2.000',
                type: 'paper',
                img: 'assets/img/2000.png',
                color: 'bg-gradient-to-br from-slate-400 to-slate-600',
                text: 'text-white border-slate-200'
            },
            {
                val: 1000,
                label: '1.000',
                type: 'coin',
                img: 'assets/img/1000.png',
                color: 'bg-gradient-to-br from-gray-200 to-gray-400',
                text: 'text-gray-700 border-gray-400'
            },
            {
                val: 500,
                label: '500',
                type: 'coin',
                img: 'assets/img/500.png',
                color: 'bg-gradient-to-br from-yellow-300 to-yellow-500',
                text: 'text-yellow-900 border-yellow-600'
            },
            {
                val: 200,
                label: '200',
                type: 'coin',
                img: 'assets/img/200.png',
                color: 'bg-gradient-to-br from-gray-300 to-gray-400',
                text: 'text-gray-800 border-gray-400'
            },
            {
                val: 100,
                label: '100',
                type: 'coin',
                img: 'assets/img/100.png',
                color: 'bg-gradient-to-br from-gray-300 to-gray-400',
                text: 'text-gray-800 border-gray-400'
            }
        ];

        // --- Game State ---
        let currentTarget = 0;
        let droppedTotal = 0;
        let droppedItems = {};
        // --- GLOBAL VARIABLES ---
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let playerName = "";
        let isGameActive = false; // Track if game is running for auto-save

        // Session Stats
        let sessionTotalTime = 0;
        let sessionLevelsCleared = 0;

        // --- Screen Management ---
        function checkNameAndStart() {
            const input = document.getElementById('player-name-input');
            const name = input.value.trim();

            if (!name) {
                // Shake animation or alert
                input.classList.add('animate-bounce'); // Simple shake replacement
                input.classList.add('border-red-500');
                SoundController.playError();
                setTimeout(() => {
                    input.classList.remove('animate-bounce');
                    input.classList.remove('border-red-500');
                }, 1000);
                return;
            }

            playerName = name;
            startGame();
        }

        function startGame() {
            // Reset Stats
            sessionTotalTime = 0;
            sessionLevelsCleared = 0;

            // Init Sound Context on user gesture
            SoundController.init();
            SoundController.playClick();
            playBackgroundMusic(); // NEW: Start Music

            // Update Greeting
            const greetingName = document.getElementById('player-name-display');
            if (greetingName) greetingName.textContent = playerName;
            const mobileGreeting = document.getElementById('greeting-display');
            // Optional: Show greeting on mobile via simpler UI if needed, currently hidden on small screens per HTML

            document.getElementById('start-screen').classList.add('hidden');
            const gameView = document.getElementById('game-view');
            gameView.classList.remove('hidden');
            gameView.classList.add('flex');
            initGame();
            isGameActive = true; // Mark game as active
        }

        function showStartScreen() {
            isGameActive = false; // Game ended or returned to home
            stopTimer(); // Ensure timer stops on exit
            SoundController.playClick();
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('flex');
            document.getElementById('start-screen').classList.remove('hidden');
        }

        function backToHome() {
            stopTimer();
            // NEW: Save progress to leaderboard on exit
            saveToLeaderboard();

            SoundController.playClick();
            showStartScreen();
        }

        function showAbout() {
            SoundController.playClick();
            document.getElementById('about-modal').classList.remove('hidden');
        }

        function closeAbout() {
            SoundController.playClick();
            document.getElementById('about-modal').classList.add('hidden');
        }

        // --- Core Logic ---
        function initGame() {
            renderSlots();
            renderSourceMoney();
            currentLevel = 1;
            score = 0;
            lives = 3;
            startNewLevel();
            updateLivesUI();
        }

        function startNewLevel() {
            currentAllowed = [];

            // NEW: Randomize Character
            updateCharacterImage();

            if (currentLevel === 1) {
                // LEVEL 1 (EASY): No constraints
                // Just match the amount using any money
                const step = 5000;
                currentTarget = (Math.floor(Math.random() * 5) + 1) * 10000;
            }
            else if (currentLevel <= 3) {
                // LEVEL 2-3 (MEDIUM): Constraints with Small Bills
                // LOGIC UPDATE: Filter out big bills (50k, 100k) to force "breaking money" feel.
                // Only allow 1k - 20k bills.
                const possible = denominations.filter(d => d.val >= 1000 && d.val <= 20000).map(d => d.val);

                const count = Math.random() > 0.5 ? 2 : 3;
                currentAllowed = shuffleArray(possible).slice(0, count);
                currentAllowed.sort((a, b) => b - a);

                // Construct target from these small bills
                currentTarget = 0;

                // 1. Force add one of each allowed type
                currentAllowed.forEach(val => {
                    currentTarget += val;
                });

                // 2. Add random extras (more extras to make the amount bigger but composed of small bills)
                const extraItems = Math.floor(Math.random() * 4) + 2; // 2-5 extra items
                for (let i = 0; i < extraItems; i++) {
                    const randomAllowed = currentAllowed[Math.floor(Math.random() * currentAllowed.length)];
                    currentTarget += randomAllowed;
                }

            } else {
                // LEVEL 4+ (HARD): Constraints with Coins & Small Bills
                // LOGIC UPDATE: Still restrict max bill to 20k to maintain difficulty.
                // Pool: 100 - 20000 (Include coins)
                const possible = denominations.filter(d => d.val <= 20000).map(d => d.val);

                currentAllowed = shuffleArray(possible).slice(0, 4);
                currentAllowed.sort((a, b) => b - a);

                // Construct target
                currentTarget = 0;

                // 1. Force add one of each allowed type
                currentAllowed.forEach(val => {
                    currentTarget += val;
                });

                // 2. Add random extras
                const extraItems = Math.floor(Math.random() * 6) + 2; // 2-7 extra items
                for (let i = 0; i < extraItems; i++) {
                    const randomAllowed = currentAllowed[Math.floor(Math.random() * currentAllowed.length)];
                    currentTarget += randomAllowed;
                }
            }

            document.getElementById('level-display').innerText = currentLevel;

            droppedTotal = 0;
            droppedItems = {};
            denominations.forEach(d => droppedItems[d.val] = 0);

            updateUI();
            updateSlotsVisuals();
            renderConstraintUI();

            startTimer(); // Start 20s timer
        }

        // --- Timer Logic ---
        let levelTimer;
        let timeLeft = 60;

        function startTimer() {
            clearInterval(levelTimer);
            timeLeft = 60;
            updateTimerUI();

            levelTimer = setInterval(() => {
                timeLeft--;
                updateTimerUI();
                if (timeLeft <= 0) {
                    clearInterval(levelTimer);
                    handleTimeout();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(levelTimer);
        }

        function updateTimerUI() {
            const el = document.getElementById('timer-display');
            if (el) {
                // Calculate minutes and seconds
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                el.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 10) {
                    el.classList.add('text-red-400', 'animate-pulse');
                    el.classList.remove('text-white');
                } else {
                    el.classList.remove('text-red-400', 'animate-pulse');
                    el.classList.add('text-white');
                }
            }
        }

        function handleTimeout() {
            // Play error sound?
            SoundController.playError();

            // Note: Timeout acts as a loss of life, not game over unless lives run out.
            // Stats are not impacted here, only on Win.

            handleLoss(
                "WAKTU HABIS!",
                "Kamu kehabisan waktu!<br>Ayo lebih cepat lagi.",
                "text-orange-500",
                '<i class="fas fa-hourglass-end"></i>'
            );
        }

        // --- Leaderboard Functions ---
        const LB_KEY = 'simakRupiahLeaderboard';

        function getLeaderboard() {
            const lb = localStorage.getItem(LB_KEY);
            return lb ? JSON.parse(lb) : [];
        }

        async function saveToLeaderboard() {
            const avgTime = sessionLevelsCleared > 0 ? (sessionTotalTime / sessionLevelsCleared).toFixed(1) : 0;
            const pName = playerName || "Anonim";

            // Prepare Data
            const entry = {
                name: pName,
                level: currentLevel,
                avgTime: parseFloat(avgTime),
                date: new Date().toISOString()
            };

            // 1. ALWAYS SAVE LOCAL FIRST (Synchronous & Fast)
            // This guarantees data is saved even if the tab closes immediately or Firebase fails.
            let lb = getLeaderboard();
            lb = lb.filter(item => item.name.toLowerCase() !== pName.toLowerCase()); // Cleanup duplicates
            lb.push(entry);
            lb.sort((a, b) => {
                if (b.level !== a.level) return b.level - a.level;
                return a.avgTime - b.avgTime;
            });
            const top10 = lb.slice(0, 10);
            localStorage.setItem(LB_KEY, JSON.stringify(top10));


            // 2. TRY FIREBASE (Async - Fire and Forget on Close)
            if (window.FirebaseAPI && window.FirebaseAPI.db) {
                try {
                    const { db, setDoc, doc, collection } = window.FirebaseAPI;
                    // Use Name as Doc ID for automatic deduplication (Upsert)
                    const docId = pName.replace(/\//g, "_");

                    await setDoc(doc(db, "leaderboard", docId), entry);
                    console.log("Score saved to Firebase!");
                } catch (e) {
                    console.error("Firebase save failed:", e);
                }
            } else {
                console.warn("Firebase not configured. Score not saved globally.");
            }
        }

        async function showLeaderboardUI() {
            const tbody = document.getElementById('lb-body');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-blue-500"><i class="fas fa-spinner fa-spin"></i> Memuat data...</td></tr>';
            document.getElementById('leaderboard-modal').classList.remove('hidden');

            let lbData = [];

            // TRY FIREBASE FETCH
            if (window.FirebaseAPI && window.FirebaseAPI.db) {
                try {
                    const { db, collection, getDocs, query, orderBy, limit } = window.FirebaseAPI;
                    const q = query(collection(db, "leaderboard"), orderBy("level", "desc"), orderBy("avgTime", "asc"), limit(10));
                    const querySnapshot = await getDocs(q);

                    querySnapshot.forEach((doc) => {
                        lbData.push(doc.data());
                    });
                } catch (e) {
                    console.error("Firebase fetch failed:", e);
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-500">Gagal memuat data online.<br><span class="text-xs text-gray-400">${e.message}</span></td></tr>`;
                    return;
                }
            } else {
                // FALLBACK: Local Storage
                lbData = getLeaderboard();
                if (lbData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Firebase belum dikonfigurasi atau data lokal kosong.</td></tr>';
                    return;
                }
            }

            // RENDER
            tbody.innerHTML = '';
            if (lbData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada data peringkat.</td></tr>';
            } else {
                lbData.forEach((entry, idx) => {
                    let rankDisplay;
                    if (idx === 0) rankDisplay = '<span class="text-2xl">ü•á</span>';
                    else if (idx === 1) rankDisplay = '<span class="text-2xl">ü•à</span>';
                    else if (idx === 2) rankDisplay = '<span class="text-2xl">ü•â</span>';
                    else rankDisplay = `<span class="font-bold text-blue-600">#${idx + 1}</span>`;

                    const row = `
                        <tr class="border-b border-gray-100 last:border-0 hover:bg-blue-50">
                            <td class="py-2 px-2 text-center">${rankDisplay}</td>
                            <td class="py-2 px-2 font-medium text-gray-800 truncate max-w-[100px]">${entry.name}</td>
                            <td class="py-2 px-2 text-center text-gray-600">${entry.level}</td>
                            <td class="py-2 px-2 text-center text-gray-600">${entry.avgTime}s</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-modal').classList.add('hidden');
        }

        // --- Helper Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderConstraintUI() {
            const area = document.getElementById('constraint-area');
            const icons = document.getElementById('constraint-icons');
            const defInstr = document.getElementById('default-instruction');

            icons.innerHTML = '';

            if (currentAllowed.length > 0) {
                area.classList.remove('hidden');
                defInstr.classList.add('hidden');

                currentAllowed.forEach(val => {
                    const d = denominations.find(x => x.val === val);

                    // MODIFIED: Changed from Image/Icon to Text Badge
                    const badge = document.createElement('span');
                    badge.className = "bg-yellow-400 text-yellow-900 px-2 py-1 rounded-md text-xs md:text-sm font-bold shadow-sm border border-yellow-600";
                    badge.innerText = `Rp ${d.label}`;

                    icons.appendChild(badge);
                });
            } else {
                area.classList.add('hidden');
                defInstr.classList.remove('hidden');
            }
        }

        function renderSlots() {
            const container = document.getElementById('slots-container');
            container.innerHTML = '';

            denominations.forEach(denom => {
                const slot = document.createElement('div');
                // INCREASED SIZE: min-h-[120px] for mobile, md:min-h-[140px] for desktop
                slot.className = `relative border-2 border-dashed border-gray-300 rounded-xl p-2 flex flex-col items-center justify-between min-h-[120px] md:min-h-[140px] bg-gray-50 transition-colors`;
                slot.id = `slot-${denom.val}`;

                slot.ondragover = (e) => {
                    e.preventDefault();
                    slot.classList.add('drop-zone-active');
                };
                slot.ondragleave = () => slot.classList.remove('drop-zone-active');
                slot.ondrop = (e) => handleDrop(e, denom.val);
                slot.onclick = () => {
                    removeMoney(denom.val);
                    SoundController.playClick(); // Sound on remove
                };

                const label = document.createElement('span');
                // INCREASED TEXT SIZE: text-sm for mobile, md:text-base for desktop, added shadow-sm
                label.className = `bg-gray-200 text-gray-600 px-2 py-1.5 rounded text-sm md:text-base font-bold mb-1 w-full text-center shadow-sm`;
                label.innerText = denom.label;

                const stack = document.createElement('div');
                stack.id = `stack-${denom.val}`;
                stack.className = 'flex-1 w-full flex items-center justify-center relative';

                const counter = document.createElement('div');
                counter.id = `count-${denom.val}`;
                counter.className = `absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-md scale-0 transition-transform duration-200`;
                counter.innerText = '0';

                slot.appendChild(label);
                slot.appendChild(stack);
                slot.appendChild(counter);
                container.appendChild(slot);
            });
        }

        function renderSourceMoney() {
            const container = document.getElementById('money-source');
            container.innerHTML = '';

            denominations.forEach(denom => {
                const moneyEl = createMoneyElement(denom);
                // Grid layout wrapper: center content
                const wrapper = document.createElement('div');
                wrapper.className = "flex items-center justify-center transform hover:-translate-y-2 transition-transform duration-200 w-full";

                moneyEl.draggable = true;
                moneyEl.ondragstart = (e) => {
                    // Play sound on pickup? Maybe distraction. Let's just do it on drop.
                    e.dataTransfer.setData("value", denom.val);
                    e.dataTransfer.effectAllowed = "copy";
                };
                moneyEl.onclick = () => addMoney(denom.val);

                wrapper.appendChild(moneyEl);
                container.appendChild(wrapper);
            });
        }

        function createMoneyElement(denom, isSmall = false) {
            const el = document.createElement('div');

            if (denom.img) {
                const img = document.createElement('img');
                img.src = denom.img;
                img.alt = denom.label;
                img.className = "w-full h-full object-contain filter drop-shadow-md select-none pointer-events-none";

                el.className = `money-card flex items-center justify-center cursor-pointer select-none transition-transform`;

                if (isSmall) {
                    // RESPONSIVE SIZING FOR DROPPED ITEMS
                    // Use percentages or max-width to fit in slots
                    if (denom.type === 'paper') {
                        // Mobile: smaller fixed size or percentage
                        el.className += " w-[80px] h-[40px] md:w-[100px] md:h-[50px]";
                    } else {
                        el.className += " w-[40px] h-[40px] md:w-[50px] md:h-[50px]";
                    }
                } else {
                    // RESPONSIVE SIZING FOR TRAY
                    // Use tailwind classes for width/height instead of fixed pixels
                    // Paper: aspect ratio approx 2:1
                    // Coin: aspect ratio 1:1

                    if (denom.type === 'paper') {
                        el.className += " w-full h-auto aspect-[2/1] max-w-[120px] md:max-w-[150px]";
                    } else {
                        el.className += " w-full h-auto aspect-square max-w-[60px] md:max-w-[80px]";
                    }
                }

                el.appendChild(img);
                return el;
            }

            // Fallback for no images
            if (denom.type === 'paper') {
                el.className = `money-card money-paper ${denom.color} ${denom.text} flex items-center justify-center font-bold shadow-md border-2 select-none`;

                if (isSmall) {
                    el.className += " w-[50px] h-[25px] md:w-[60px] md:h-[30px]";
                } else {
                    el.className += " w-[100px] h-[50px] md:w-[150px] md:h-[75px]";
                }

                // Larger text for source money
                el.innerHTML = `<span class="${isSmall ? 'text-[8px]' : 'text-sm md:text-xl'}">Rp${denom.label}</span>`;
            } else {
                el.className = `money-card money-coin ${denom.color} ${denom.text} flex items-center justify-center font-bold border-4 select-none`;

                if (isSmall) {
                    el.className += " w-[25px] h-[25px] md:w-[30px] md:h-[30px]";
                } else {
                    el.className += " w-[50px] h-[50px] md:w-[80px] md:h-[80px]";
                }

                el.innerHTML = `<span class="${isSmall ? 'text-[6px]' : 'text-xs md:text-lg'}">${denom.label}</span>`;
            }
            return el;
        }

        // --- Interaction Logic ---
        function handleDrop(e, slotVal) {
            e.preventDefault();
            const draggedVal = parseInt(e.dataTransfer.getData("value"));
            document.getElementById(`slot-${slotVal}`).classList.remove('drop-zone-active');

            if (draggedVal === slotVal) {
                addMoney(draggedVal);
            } else {
                SoundController.playError(); // Wrong slot sound
                const slot = document.getElementById(`slot-${slotVal}`);
                slot.classList.add('bg-red-100');
                setTimeout(() => slot.classList.remove('bg-red-100'), 200);
            }
        }

        function addMoney(val) {
            droppedTotal += val;
            droppedItems[val]++;

            // Play correct sound based on type
            const denom = denominations.find(d => d.val === val);
            if (denom && denom.type === 'coin') {
                SoundController.playCoin();
            } else {
                SoundController.playPaper();
            }

            renderStackItem(val);
            updateUI();
        }

        function removeMoney(val) {
            if (droppedItems[val] > 0) {
                droppedTotal -= val;
                droppedItems[val]--;
                updateSlotsVisuals();
                updateUI();
            }
        }

        function renderStackItem(val) {
            const denom = denominations.find(d => d.val === val);
            const stack = document.getElementById(`stack-${val}`);

            const item = createMoneyElement(denom, true);
            item.classList.add('pop-in', 'absolute');

            const rotate = Math.floor(Math.random() * 20) - 10;
            const offsetX = Math.floor(Math.random() * 10) - 5;
            const offsetY = Math.floor(Math.random() * 10) - 5;

            item.style.transform = `rotate(${rotate}deg) translate(${offsetX}px, ${offsetY}px)`;
            item.style.zIndex = droppedItems[val];

            stack.appendChild(item);

            const counter = document.getElementById(`count-${val}`);
            counter.innerText = droppedItems[val];
            counter.classList.remove('scale-0');
        }

        function updateSlotsVisuals() {
            denominations.forEach(denom => {
                const stack = document.getElementById(`stack-${denom.val}`);
                stack.innerHTML = '';

                const count = droppedItems[denom.val];
                const counter = document.getElementById(`count-${denom.val}`);
                counter.innerText = count;

                if (count === 0) {
                    counter.classList.add('scale-0');
                } else {
                    counter.classList.remove('scale-0');
                    for (let i = 0; i < count; i++) {
                        const item = createMoneyElement(denom, true);
                        item.classList.add('absolute');
                        const rotate = Math.floor(Math.random() * 20) - 10;
                        item.style.transform = `rotate(${rotate}deg)`;
                        stack.appendChild(item);
                    }
                }
            });
        }

        function updateUI() {
            const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });

            document.getElementById('target-amount').innerText = formatter.format(currentTarget);
            const currentTotalEl = document.getElementById('current-total');
            currentTotalEl.innerText = formatter.format(droppedTotal);

            if (droppedTotal === currentTarget) {
                currentTotalEl.className = "text-green-400 font-mono text-3xl md:text-4xl text-right font-bold tracking-widest";
            } else if (droppedTotal > currentTarget) {
                currentTotalEl.className = "text-red-400 font-mono text-3xl md:text-4xl text-right font-bold tracking-widest";
            } else {
                currentTotalEl.className = "text-yellow-400 font-mono text-3xl md:text-4xl text-right font-bold tracking-widest";
            }

            document.getElementById('score').innerText = score;
        }

        function checkAnswer() {
            SoundController.playClick();

            if (droppedTotal !== currentTarget) {
                SoundController.playError();
                if (droppedTotal > currentTarget) {
                    handleLoss('‚ö†Ô∏è KELEBIHAN!', 'Total uangmu melebihi yang diminta.', 'text-orange-500', '<i class="fas fa-exclamation-triangle"></i>');
                } else {
                    handleLoss('üìâ KURANG!', 'Total uangmu masih kurang.', 'text-yellow-500', '<i class="fas fa-hand-holding-usd"></i>');
                }
                return;
            }

            if (currentAllowed.length > 0) {
                let illegalItemFound = false;
                let illegalName = '';

                for (const [val, count] of Object.entries(droppedItems)) {
                    if (count > 0 && !currentAllowed.includes(parseInt(val))) {
                        illegalItemFound = true;
                        const d = denominations.find(x => x.val == val);
                        illegalName = d ? d.label : val;
                        break;
                    }
                }

                if (illegalItemFound) {
                    SoundController.playError();
                    handleLoss('üö´ PECAHAN SALAH!', `Totalnya pas, tapi kamu menggunakan pecahan <b>${illegalName}</b> yang dilarang di level ini!`, 'text-red-500', '<i class="fas fa-ban"></i>');
                    return;
                }
            }

            SoundController.playWin();
            handleWin();
        }

        // --- Modals & Game Over ---
        function handleWin() {
            stopTimer(); // Stop timer on win

            // Track Stats
            const timeUsed = 60 - timeLeft;
            sessionTotalTime += timeUsed;
            sessionLevelsCleared++;

            const bonus = 100 + (currentLevel * 10);
            score += bonus;
            currentLevel++;

            showModal(
                'üéâ BERHASIL!',
                `Hebat! Jawabanmu benar. <br>Lanjut ke <b>Level ${currentLevel}</b>!`,
                'text-green-500',
                '<i class="fas fa-arrow-circle-up"></i>'
            );
        }

        function handleLoss(title, msg, colorClass, iconHtml) {
            stopTimer(); // Stop timer on loss/timeout
            lives--;
            updateLivesUI();

            if (lives <= 0) {
                // Game Over - Save Score
                saveToLeaderboard();

                showModal(
                    'GAME OVER',
                    `Kesempatan habis.<br>Kamu bertahan sampai <b>Level ${currentLevel}</b>.<br>Skor Akhir: ${score}`,
                    'text-red-600',
                    '<i class="fas fa-skull"></i>',
                    true
                );
            } else {
                showModal(title, msg, colorClass, iconHtml);
            }
        }

        function updateLivesUI() {
            const container = document.getElementById('lives-container');
            container.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('i');
                heart.className = `fas fa-heart text-2xl md:text-3xl drop-shadow-md ${i < lives ? 'text-red-500' : 'text-gray-400'}`;
                container.appendChild(heart);
            }
        }

        function showModal(title, message, colorClass, iconHtml, isReset = false) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');

            // Responsive padding
            content.className = "bg-white rounded-3xl p-6 md:p-8 max-w-sm w-full text-center transform scale-90 transition-transform duration-300";

            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-title').className = `text-2xl md:text-3xl font-bold mb-2 ${colorClass}`;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('modal-message').className = "text-gray-600 mb-6 text-sm md:text-lg";

            document.getElementById('modal-icon').innerHTML = iconHtml;
            document.getElementById('modal-icon').className = `text-5xl md:text-6xl mb-4 animate-bounce ${colorClass}`;

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-90');
                content.classList.add('scale-100');
            }, 10);

            const btn = content.querySelector('button');
            btn.onclick = () => {
                SoundController.playClick();
                closeModal();
                if (isReset) {
                    showStartScreen();
                } else if (title === 'üéâ BERHASIL!' || title === 'WAKTU HABIS!') {
                    startNewLevel();
                }
            };
        }

        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            modal.classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial Render
            // start-screen is visible by default
            initFloatingMoney(); // NEW: Start animation

            // Try to play music immediately
            playBackgroundMusic();
        });

        // --- NEW: Floating Money Logic ---
        function initFloatingMoney() {
            const container = document.getElementById('floating-money-container');
            if (!container) return; // Guard

            const images = ['100000.png', '50000.png', '20000.png', '10000.png', '5000.png', '2000.png', '1000.png', '500.png'];
            const count = 15; // Number of floating items

            for (let i = 0; i < count; i++) {
                const img = document.createElement('img');
                const randomImage = images[Math.floor(Math.random() * images.length)];

                img.src = `assets/img/${randomImage}`;
                img.classList.add('floating-money');

                // Random Properties
                const left = Math.random() * 100; // 0-100%
                const duration = Math.random() * 10 + 5; // 5-15s
                const delay = Math.random() * 5; // 0-5s

                // Depth Effect (Blur/Scale)
                const depth = Math.random();
                let scale, blur, opacity;

                if (depth < 0.3) {
                    // Far (Small, Blurred, Faint)
                    scale = Math.random() * 0.3 + 0.3; // 0.3 - 0.6
                    blur = '2px';
                    opacity = 0.4;
                } else if (depth < 0.7) {
                    // Mid
                    scale = Math.random() * 0.4 + 0.6; // 0.6 - 1.0
                    blur = '0px';
                    opacity = 0.7;
                } else {
                    // Close (Big, slightly blurred if too close or clear)
                    scale = Math.random() * 0.5 + 1.0; // 1.0 - 1.5
                    blur = (scale > 1.3) ? '4px' : '0px'; // Blur if "too close" to camera
                    opacity = 0.9;
                }

                img.style.left = `${left}%`;
                // Base width relative for responsiveness
                img.style.width = '120px';

                img.style.animationName = 'floatDown';
                img.style.animationDuration = `${duration}s`;
                img.style.animationDelay = `-${delay}s`; // Start mid-animation
                img.style.animationTimingFunction = 'linear';
                img.style.animationIterationCount = 'infinite';

                // Apply visual transforms
                img.style.transform = `scale(${scale})`; // Initial scale, keyframes handle translate/rotate
                // Note: Keyframes override 'transform'. If keyframes use transform, this inline transform is ignored!
                // FIX: Apply scale to width/height OR Wrap in a div.
                // Let's change the strategy: Apply scale via width.
                img.style.width = `${120 * scale}px`;
                img.style.transform = ''; // Clear transform so it doesn't conflict if ever needed, but keyframe wins.

                img.style.filter = `blur(${blur})`;
                img.style.opacity = opacity;

                container.appendChild(img);
            }
        }


        // --- NEW: Background Music Logic ---
        const bgMusic = document.getElementById('bg-music');
        let isMusicPlaying = false;

        function playBackgroundMusic() {
            if (bgMusic) {
                bgMusic.volume = 1.0; // Max volume for testing
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicBtn();
                }).catch(e => {
                    console.log("Autoplay prevented:", e);
                    // DEBUG: Show alert only if it's NOT an allowed/interaction error to avoid spamming on refresh
                    // But for now, user wants to know why it fails.
                    // If it is 'NotAllowedError', it means user interaction is needed.
                    if (e.name === 'NotAllowedError') {
                        // Optional: could show a toast "Click to play music"
                        console.warn("User user interaction needed for music.");
                    } else {
                        alert("Music failed to play: " + e.message);
                    }
                    isMusicPlaying = false;
                    updateMusicBtn();
                });
            }
        }

        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play();
                isMusicPlaying = true;
            } else {
                bgMusic.pause();
                isMusicPlaying = false;
            }
            updateMusicBtn();
            SoundController.playClick();
        }

        function updateMusicBtn() {
            const btn = document.getElementById('music-btn');
            if (btn) {
                if (isMusicPlaying) {
                    btn.innerHTML = '<i class="fas fa-volume-up text-sm md:text-base"></i>';
                    btn.classList.remove('bg-red-500/50');
                    btn.classList.add('bg-white/20');
                } else {
                    btn.innerHTML = '<i class="fas fa-volume-mute text-sm md:text-base"></i>';
                    btn.classList.add('bg-red-500/50');
                    btn.classList.remove('bg-white/20');
                }
            }
        }
    </script>

</body>

</html>